{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}AI Chat Assistant{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .chat-messages {
        height: calc(100% - 60px);
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message.user {
        background: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message.ai {
        background: white;
        border: 1px solid #ddd;
        margin-right: auto;
    }
    
    .message.system {
        background: #e9ecef;
        color: #6c757d;
        text-align: center;
        font-style: italic;
        margin: 0 auto;
    }
    
    .chat-input {
        height: 60px;
        border-top: 1px solid #ddd;
        padding: 10px;
        background: white;
    }
    
    .ai-status {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .ai-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .feature-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .typing-indicator {
        display: none;
        color: #6c757d;
        font-style: italic;
    }
    
    .typing-indicator.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">ü§ñ AI Chat Assistant</h2>
            
            <!-- AI Status -->
            <div class="ai-status">
                <h4>üß† AI Assistant ƒëang ho·∫°t ƒë·ªông</h4>
                <p class="mb-0">T√¥i c√≥ th·ªÉ gi√∫p b·∫°n v·ªÅ tr·∫°ng th√°i h√≥a ƒë∆°n, h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng h·ªá th·ªëng, v√† ph√¢n t√≠ch d·ªØ li·ªáu.</p>
            </div>
            
            <!-- AI Features -->
            <div class="ai-features">
                <div class="feature-card">
                    <h6>üìä Ph√¢n t√≠ch h√≥a ƒë∆°n</h6>
                    <small>H·ªèi v·ªÅ tr·∫°ng th√°i, ph√¢n lo·∫°i, r·ªßi ro fraud</small>
                </div>
                <div class="feature-card">
                    <h6>üîç H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h6>
                    <small>Gi·∫£i th√≠ch c√°ch upload, ph√™ duy·ªát, b√°o c√°o</small>
                </div>
                <div class="feature-card">
                    <h6>üìà Th·ªëng k√™ & B√°o c√°o</h6>
                    <small>Ph√¢n t√≠ch hi·ªáu su·∫•t, t·ª∑ l·ªá kh·ªõp, xu h∆∞·ªõng</small>
                </div>
                <div class="feature-card">
                    <h6>üõ†Ô∏è Kh·∫Øc ph·ª•c s·ª± c·ªë</h6>
                    <small>Gi·∫£i quy·∫øt l·ªói OCR, t√≠ch h·ª£p ERP</small>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        üëã Xin ch√†o! T√¥i l√† AI Assistant c·ªßa h·ªá th·ªëng x·ª≠ l√Ω h√≥a ƒë∆°n. B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?
                    </div>
                </div>
                
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> G·ª≠i
                        </button>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        AI ƒëang suy nghƒ©...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = null;

// Kh·ªüi t·∫°o session
function initSession() {
    if (!sessionId) {
        sessionId = generateSessionId();
    }
}

// T·∫°o session ID
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// G·ª≠i tin nh·∫Øn
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o chat
    addMessage('user', message);
    input.value = '';
    
    // Hi·ªÉn th·ªã typing indicator
    showTypingIndicator();
    
    try {
        const response = await fetch('/api/ai/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // ·∫®n typing indicator
            hideTypingIndicator();
            
            // Th√™m ph·∫£n h·ªìi AI
            addMessage('ai', data.response);
            
            // C·∫≠p nh·∫≠t session ID
            if (data.session_id) {
                sessionId = data.session_id;
            }
        } else {
            hideTypingIndicator();
            addMessage('system', '‚ùå L·ªói: ' + data.error);
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('system', '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
    }
}

// Th√™m tin nh·∫Øn v√†o chat
function addMessage(type, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = content;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hi·ªÉn th·ªã typing indicator
function showTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('show');
}

// ·∫®n typing indicator
function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.remove('show');
}

// X·ª≠ l√Ω ph√≠m Enter
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// L·∫•y CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Kh·ªüi t·∫°o khi trang load
document.addEventListener('DOMContentLoaded', function() {
    initSession();
    
    // Focus v√†o input
    document.getElementById('messageInput').focus();
    
    // Th√™m m·ªôt s·ªë c√¢u h·ªèi m·∫´u
    addMessage('system', 'üí° B·∫°n c√≥ th·ªÉ h·ªèi: "Tr·∫°ng th√°i h√≥a ƒë∆°n ID 1", "H∆∞·ªõng d·∫´n upload h√≥a ƒë∆°n", "B√°o c√°o th·ªëng k√™"');
});
</script>
{% endblock %}

