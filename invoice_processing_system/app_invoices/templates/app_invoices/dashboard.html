{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}Dashboard - InvoiceFlow{% endblock %}

{% block content %}
<header class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-3xl font-semibold text-gray-800">Dashboard</h2>
        <p class="text-gray-600 mt-1">T·ªïng quan h·ªá th·ªëng x·ª≠ l√Ω h√≥a ƒë∆°n</p>
    </div>
    <a href="{% url 'app_invoices:invoice-list' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-md">
        üìÑ T·∫£i H√≥a ƒê∆°n M·ªõi
    </a>
</header>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-indigo-100">
                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">T·ªïng s·ªë h√≥a ƒë∆°n</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="total_invoices">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Ch·ªù ph√™ duy·ªát</h3>
                <p class="text-3xl font-bold text-yellow-500 mt-1" id="pending_approval">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">ƒê√£ kh·ªõp</h3>
                <p class="text-3xl font-bold text-green-500 mt-1" id="matched_count">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">L·ªói t√≠ch h·ª£p</h3>
                <p class="text-3xl font-bold text-red-500 mt-1" id="integration_errors">0</p>
            </div>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Th√¥ng b√°o & Nhi·ªám v·ª• c·ªßa t√¥i</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H√≥a ƒë∆°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nhi·ªám v·ª•</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tr·∫°ng th√°i</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ng√†y t·∫°o</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="notification_list" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">ƒêang t·∫£i th√¥ng b√°o...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">T·ª∑ l·ªá kh·ªõp h√≥a ƒë∆°n</h3>
        <canvas id="matchRateChart" height="200"></canvas>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Th·ªëng k√™ hi·ªáu su·∫•t</h3>
        <div class="space-y-4">
            <div>
                <p class="text-2xl font-bold text-blue-600" id="avg_processing_time">0s</p>
                <p class="text-gray-500 text-sm">Th·ªùi gian x·ª≠ l√Ω trung b√¨nh</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-green-600" id="total_processed_amount">0ƒë</p>
                <p class="text-gray-500 text-sm">T·ªïng gi√° tr·ªã ƒë√£ x·ª≠ l√Ω</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-indigo-600" id="auto_matched_count">0</p>
                <p class="text-gray-500 text-sm">H√≥a ƒë∆°n kh·ªõp t·ª± ƒë·ªông</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ‚úÖ URL API Dashboard v√† Tasks
    const DASHBOARD_API_URL = "{% url 'app_api:api-stats' %}"; 
    const MY_TASKS_API_URL = "{% url 'app_api:api-tasks-list' %}";

    // ‚úÖ Template link chi ti·∫øt h√≥a ƒë∆°n
    const INVOICE_DETAIL_URL_TEMPLATE = "{% url 'app_invoices:invoice-detail' pk=0 %}".replace('0', '__INVOICE_ID__');

    /**
     * üß© H√†m g·ªçi API Dashboard v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªÉn th·ªã
     */
    async function fetchDashboardData() {
        try {
            const response = await fetch(DASHBOARD_API_URL);

            // Ki·ªÉm tra l·ªói login ho·∫∑c ƒë·ªãnh d·∫°ng tr·∫£ v·ªÅ
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.error("API kh√¥ng tr·∫£ v·ªÅ JSON. C√≥ th·ªÉ c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.");
                window.location.href = "{% url 'app_invoices:login' %}?next=" + window.location.pathname;
                return;
            }

            if (!response.ok) throw new Error(`L·ªói HTTP ${response.status}`);

            const data = await response.json();

            // ‚úÖ C·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™
            document.getElementById('total_invoices').textContent = data.total_invoices?.toLocaleString() || '0';
            document.getElementById('pending_approval').textContent = data.pending_approval?.toLocaleString() || '0';
            document.getElementById('matched_count').textContent = data.matched_count?.toLocaleString() || '0';
            document.getElementById('integration_errors').textContent = data.integration_errors?.toLocaleString() || '0';
            document.getElementById('avg_processing_time').textContent = data.avg_processing_time || '0s';
            document.getElementById('auto_matched_count').textContent = data.auto_matched_count?.toLocaleString() || '0';

            const totalAmount = data.total_processed_amount || 0;
            document.getElementById('total_processed_amount').textContent =
                totalAmount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

            // ‚úÖ C·∫≠p nh·∫≠t danh s√°ch nhi·ªám v·ª•/th√¥ng b√°o
            updateNotificationList(data.recent_notifications || []);

        } catch (error) {
            console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu Dashboard:', error);
        }
    }

    /**
     * üß© H√†m c·∫≠p nh·∫≠t danh s√°ch nhi·ªám v·ª•/th√¥ng b√°o
     */
    function updateNotificationList(notifications) {
        const notificationList = document.getElementById('notification_list');
        if (!notificationList) return;

        notificationList.innerHTML = ''; 
        const totalColumns = 5;

        if (notifications.length > 0) {
            notifications.forEach(notification => {
                const invoiceId = notification.invoice?.id ?? 'N/A';
                const detailUrl = invoiceId !== 'N/A'
                    ? INVOICE_DETAIL_URL_TEMPLATE.replace('__INVOICE_ID__', invoiceId)
                    : '#';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="${detailUrl}" class="text-indigo-600 hover:text-indigo-900">
                            ${notification.invoice?.invoice_number || 'N/A'}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${notification.task_type_display || notification.action || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${notification.status || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${notification.created_at_display || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="${detailUrl}" class="text-indigo-600 hover:text-indigo-900">Xem</a>
                    </td>
                `;
                notificationList.appendChild(row);
            });
        } else {
            notificationList.innerHTML = `
                <tr>
                    <td colspan="${totalColumns}" class="px-6 py-4 text-center text-sm text-gray-500">
                        Kh√¥ng c√≥ nhi·ªám v·ª• ho·∫∑c th√¥ng b√°o g·∫ßn ƒë√¢y.
                    </td>
                </tr>`;
        }
    }

    /**
     * üß† H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi khi OCR ho√†n t·∫•t ·ªü trang kh√°c
     * (v√≠ d·ª•: t·ª´ trang chi ti·∫øt h√≥a ƒë∆°n g·ªçi qua window.parent.refreshDashboard())
     */
    window.refreshDashboard = async function() {
        console.log("üîÑ L√†m m·ªõi Dashboard sau khi OCR ho√†n t·∫•t...");
        await fetchDashboardData();
    }

    /**
     * ‚öôÔ∏è T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu Dashboard khi trang load
     */
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchDashboardData();

        // ‚è±Ô∏è (T√πy ch·ªçn) T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 10 gi√¢y
        setInterval(fetchDashboardData, 10000);
    });

</script>
{% endblock %}
