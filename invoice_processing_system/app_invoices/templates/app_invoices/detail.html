{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}Chi ti·∫øt H√≥a ƒë∆°n{% endblock %}

{% block content %}
<div class="p-6 bg-gray-50 min-h-screen">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">üßæ Chi ti·∫øt H√≥a ƒë∆°n</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">üì∑ H√¨nh ·∫£nh H√≥a ƒë∆°n</h2>
            {% if invoice.file %}
                <img src="{{ invoice.file.url }}" alt="Invoice Image" class="rounded-lg shadow">
            {% else %}
                <p class="text-gray-500 italic">Kh√¥ng c√≥ h√¨nh ·∫£nh h√≥a ƒë∆°n</p>
            {% endif %}
            <p class="mt-3 text-sm text-gray-600">
                <strong>Tr·∫°ng th√°i:</strong> {{ invoice.get_status_display }} <br>
                <strong>Ng√†y t·∫£i l√™n:</strong> {{ invoice.uploaded_at|date:"d/m/Y H:i" }}
            </p>
        </div>

        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">üß† K·∫øt qu·∫£ OCR</h2>
            <form id="ocrForm" class="mb-4">
                <input type="hidden" name="invoice_id" value="{{ invoice.id }}"> <button type="button" id="runOcrBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    üîÑ Ch·∫°y l·∫°i OCR
                </button>
            </form>

            <script>
            document.getElementById("runOcrBtn").addEventListener("click", async () => {
                const invoiceId = document.querySelector("[name='invoice_id']").value;
                const btn = document.getElementById("runOcrBtn");
                btn.disabled = true;
                btn.innerText = "ƒêang x·ª≠ l√Ω...";
                
                // üéØ ƒê√É S·ª¨A L·ªñI URL: S·ª≠a th√†nh /api/ocr-async/ (ho·∫∑c /api/ocr-sync/ n·∫øu mu·ªën ch·∫°y ƒë·ªìng b·ªô)
                const res = await fetch("{% url 'app_api:api-ocr-async' %}", {
                    method: "POST",
                    headers: {
                        // FIX: L·∫•y CSRF token t·ª´ m·ªôt th·∫ª input ·∫©n thay v√¨ d√πng template tag trong script
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value || "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ invoice_id: invoiceId })
                });

                // X·ª≠ l√Ω response
                let data = {};
                try {
                    data = await res.json();
                } catch (e) {
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p server kh√¥ng tr·∫£ v·ªÅ JSON (v√≠ d·ª•: l·ªói 500 HTML)
                    console.error("L·ªói parse JSON:", e);
                }
                
                if (res.ok) {
                    alert("‚úÖ Y√™u c·∫ßu OCR th√†nh c√¥ng. H·ªá th·ªëng ƒëang x·ª≠ l√Ω trong n·ªÅn.");
                    // Kh√¥ng c·∫ßn reload ngay, ƒë·ªÉ ng∆∞·ªùi d√πng theo d√µi tr·∫°ng th√°i
                    // Thay v√†o ƒë√≥, b·∫°n c√≥ th·ªÉ t·ª± ƒë·ªông l√†m m·ªõi ph·∫ßn tr·∫°ng th√°i.
                    location.reload(); 
                } else {
                    alert("‚ùå L·ªói OCR: " + (data.error || `L·ªói kh√¥ng x√°c ƒë·ªãnh (${res.status} ${res.statusText})`));
                    btn.disabled = false;
                    btn.innerText = "üîÑ Ch·∫°y l·∫°i OCR";
                }
            });
            </script>

            {% if invoice.ocr_text %}
                <pre class="bg-gray-100 p-3 rounded text-sm text-gray-800 whitespace-pre-line">{{ invoice.ocr_text }}</pre>
            {% else %}
                <p class="text-gray-500 italic">Ch∆∞a c√≥ d·ªØ li·ªáu OCR.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}