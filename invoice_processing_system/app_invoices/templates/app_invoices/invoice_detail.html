{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}Chi ti·∫øt H√≥a ƒë∆°n - {{ invoice.invoice_number }}{% endblock title %}

{% block content %}
<div class="p-6 bg-gray-50 min-h-screen">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">üßæ Chi ti·∫øt H√≥a ƒë∆°n</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- C·ªòT TR√ÅI: ·∫¢NH H√ìA ƒê∆†N -->
        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">üì∑ H√¨nh ·∫£nh H√≥a ƒë∆°n</h2>
            {% if invoice.file %}
                <img id="invoiceImage" src="{{ invoice.file.url }}" alt="Invoice Image" class="rounded-lg shadow max-w-full h-auto">
            {% else %}
                <p class="text-gray-500 italic">Kh√¥ng c√≥ h√¨nh ·∫£nh h√≥a ƒë∆°n</p>
            {% endif %}
            
            <p class="mt-3 text-sm text-gray-600">
                <strong>Tr·∫°ng th√°i:</strong> 
                <span id="currentStatus" class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium">
                    {{ invoice.get_status_display }}
                </span><br>
                <strong>Ng√†y t·∫£i l√™n:</strong> {{ invoice.uploaded_at|date:"d/m/Y H:i" }}
            </p>
        </div>

        <!-- C·ªòT PH·∫¢I: D·ªÆ LI·ªÜU H√ìA ƒê∆†N -->
        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üîé D·ªØ li·ªáu H√≥a ƒë∆°n</h2>
            <div id="ocrDataContainer" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <p>ƒêang t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n...</p>
                </div>
            </div>

            {% if invoice.raw_ocr_text %}
            <div class="mt-6 bg-gray-50 p-4 rounded border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-2">üìú VƒÉn b·∫£n OCR (Tesseract)</h3>
                <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ invoice.raw_ocr_text }}</pre>
            </div>
            {% else %}
            <div class="mt-6 text-gray-500 italic text-sm text-center">Ch∆∞a c√≥ d·ªØ li·ªáu OCR hi·ªÉn th·ªã.</div>
            {% endif %}

            <h2 class="text-lg font-semibold text-gray-700 mt-6 mb-3">üß† T√°c v·ª• X·ª≠ l√Ω</h2>
            <div class="flex space-x-2">
                {% csrf_token %}
                <button type="button" id="runOcrBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm shadow-md">
                    üîÑ Ch·∫°y l·∫°i OCR
                </button>
                <button type="button" id="runMatchBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm shadow-md">
                    üîó Kh·ªõp/T·∫°o ERP
                </button>
                <button type="button" id="approveBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm shadow-md">
                    ‚úÖ Ph√™ duy·ªát
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // ƒë·∫£m b·∫£o lu√¥n d√πng invoice.id (kh√¥ng d√πng invoice_id n·∫øu b·∫°n ch∆∞a truy·ªÅn)
    const INVOICE_ID = "{{ invoice.id }}";
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // H√†m h·ªØu √≠ch
    function formatCurrency(value) {
        if (!value || isNaN(value)) return 'N/A';
        return parseFloat(value).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    async function fetchInvoiceDetails() {
        const container = document.getElementById('ocrDataContainer');
        try {
            const res = await fetch(`/api/invoices/${INVOICE_ID}/`);
            if (!res.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n.");
            const data = await res.json();
            // c·∫≠p nh·∫≠t UI (n·∫øu c·∫ßn)
            let html = `<div class="bg-gray-100 p-4 rounded-lg">
                <p><strong>S·ªë h√≥a ƒë∆°n:</strong> ${data.invoice_number || 'N/A'}</p>
                <p><strong>T·ªïng ti·ªÅn:</strong> ${formatCurrency(data.total_amount)}</p>
            </div>`;
            if (data.raw_ocr_text) {
                html += `<div class="mt-4 bg-gray-50 p-3 rounded border border-gray-200"><pre class="whitespace-pre-wrap text-sm text-gray-700">${data.raw_ocr_text}</pre></div>`;
            }
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">‚ùå ${error.message}</div>`;
        }
    }

    // Ch·∫°y l·∫°i OCR (g·ªçi endpoint ocr-async)
    document.getElementById("runOcrBtn").addEventListener("click", async () => {
        const btn = document.getElementById("runOcrBtn");
        btn.disabled = true;
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        const res = await fetch("/api/ocr-async/", {
            method: "POST",
            headers: { "X-CSRFToken": CSRF_TOKEN, "Content-Type": "application/json" },
            body: JSON.stringify({ invoice_id: INVOICE_ID })
        });
        btn.disabled = false;
        btn.innerText = "üîÑ Ch·∫°y l·∫°i OCR";
        const data = await res.json().catch(()=>({}));
        alert(data.message || data.error || (res.ok ? "Y√™u c·∫ßu OCR ƒë√£ g·ª≠i." : "L·ªói khi g·ªçi OCR."));
        fetchInvoiceDetails();
    });

    // Kh·ªõp ERP
    document.getElementById("runMatchBtn").addEventListener("click", async () => {
        const res = await fetch(`/api/invoices/${INVOICE_ID}/match/`, {
            method: "POST",
            headers: { "X-CSRFToken": CSRF_TOKEN },
        });
        const data = await res.json().catch(()=>({}));
        alert(data.message || data.error || (res.ok ? "ƒê√£ kh·ªõp ERP." : "L·ªói kh·ªõp ERP."));
        fetchInvoiceDetails();
    });

    // Ph√™ duy·ªát
    document.getElementById("approveBtn").addEventListener("click", async () => {
        const res = await fetch(`/api/invoices/${INVOICE_ID}/approve/`, {
            method: "POST",
            headers: { "X-CSRFToken": CSRF_TOKEN },
        });
        const data = await res.json().catch(()=>({}));
        alert(data.message || data.error || (res.ok ? "ƒê√£ ph√™ duy·ªát." : "L·ªói ph√™ duy·ªát."));
        fetchInvoiceDetails();
    });

    // initial load
    fetchInvoiceDetails();
    setInterval(fetchInvoiceDetails, 10000);
</script>
{% endblock extra_js %}
