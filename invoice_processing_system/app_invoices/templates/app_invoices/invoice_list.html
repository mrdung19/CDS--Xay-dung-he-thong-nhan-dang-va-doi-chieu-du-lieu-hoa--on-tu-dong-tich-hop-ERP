{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}X·ª≠ l√Ω H√≥a ƒë∆°n - InvoiceFlow{% endblock %}

{% block content %}
<header class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-3xl font-semibold text-gray-800">X·ª≠ l√Ω H√≥a ƒë∆°n</h2>
        <p class="text-gray-600 mt-1">T·∫£i l√™n v√† qu·∫£n l√Ω c√°c h√≥a ƒë∆°n</p>
    </div>
</header>

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">üì§ T·∫£i l√™n H√≥a ƒë∆°n m·ªõi</h3>
    <form id="uploadForm" class="flex flex-col space-y-4">
        {% csrf_token %}
        <div>
            <label for="invoice_file" class="block text-gray-700 text-sm font-bold mb-2">
                Ch·ªçn file h√≥a ƒë∆°n (PDF, JPG, PNG):
            </label>
            <input type="file" id="invoice_file" name="file" accept=".pdf,.jpg,.jpeg,.png"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md 
                file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 
                hover:file:bg-indigo-100" required>
            <p class="text-xs text-gray-500 mt-1">H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng PDF, JPG, PNG. K√≠ch th∆∞·ªõc t·ªëi ƒëa 10MB.</p>
        </div>
        <button type="submit"
            class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-md self-start">
            üöÄ T·∫£i l√™n & X·ª≠ l√Ω OCR
        </button>
        <div id="uploadStatus" class="mt-2 text-sm"></div>
    </form>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">üìã Danh s√°ch H√≥a ƒë∆°n</h3>
        <div class="flex space-x-2">
            <button onclick="filterInvoices('all')" class="px-3 py-1 text-xs font-medium rounded-md bg-gray-200 hover:bg-gray-300">T·∫•t c·∫£</button>
            <button onclick="filterInvoices('pending')" class="px-3 py-1 text-xs font-medium rounded-md bg-yellow-200 hover:bg-yellow-300">Ch·ªù x·ª≠ l√Ω</button>
            <button onclick="filterInvoices('matched')" class="px-3 py-1 text-xs font-medium rounded-md bg-green-200 hover:bg-green-300">ƒê√£ kh·ªõp</button>
            <button onclick="filterInvoices('error')" class="px-3 py-1 text-xs font-medium rounded-md bg-red-200 hover:bg-red-300">L·ªói</button>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S·ªë H√≥a ƒë∆°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nh√† cung c·∫•p</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T·ªïng ti·ªÅn</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tr·∫°ng th√°i</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ng√†y t·∫£i l√™n</th>
                    <th class="relative px-6 py-3"><span class="sr-only">H√†nh ƒë·ªông</span></th>
                </tr>
            </thead>
            <tbody id="invoiceTableBody" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center">ƒêang t·∫£i h√≥a ƒë∆°n...</td></tr>
            </tbody>
        </table>
    </div>
    <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>
</div>
{% endblock %}
    
{% block extra_js %}
<script>
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let currentFilter = 'all';
    let currentPage = 1;
    const pageSize = 10;

    const UPLOAD_API_URL = "{% url 'app_api:api-invoices-list' %}";
    const LIST_API_URL = "{% url 'app_api:api-invoices-list' %}";
    const DETAIL_URL_TEMPLATE = "{% url 'app_invoices:invoice-detail' pk=0 %}".replace('0', '__INVOICE_ID__');

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('invoice_file');
        const uploadStatus = document.getElementById('uploadStatus');

        if (fileInput.files.length === 0) {
            uploadStatus.className = 'text-red-500';
            uploadStatus.innerText = 'Vui l√≤ng ch·ªçn m·ªôt file h√≥a ƒë∆°n.';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadStatus.className = 'text-blue-500';
        uploadStatus.innerHTML = '<div class="flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ƒêang t·∫£i l√™n v√† x·ª≠ l√Ω OCR...</div>';

        try {
            const response = await fetch(UPLOAD_API_URL, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                },
                body: formData,
            });

            if (response.headers.get('content-type') && response.headers.get('content-type').indexOf('application/json') === -1) {
                throw new Error(`Unexpected response format. Status: ${response.status}. API c√≥ th·ªÉ y√™u c·∫ßu ƒêƒÉng nh·∫≠p ho·∫∑c thi·∫øu quy·ªÅn.`);
            }

            if (response.ok) {
                const result = await response.json();
                uploadStatus.className = 'text-green-500';
                uploadStatus.innerHTML = `<div class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>H√≥a ƒë∆°n ${result.invoice_number || result.id} ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng v√† ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω!</div>`;
                fileInput.value = '';
                fetchInvoices(); // Refresh invoice list
            } else {
                const error = await response.json();
                uploadStatus.className = 'text-red-500';
                uploadStatus.innerText = `L·ªói khi t·∫£i l√™n: ${JSON.stringify(error)}`;
            }
        } catch (error) {
            uploadStatus.className = 'text-red-500';
            uploadStatus.innerText = `C√≥ l·ªói m·∫°ng ho·∫∑c l·ªói kh√¥ng x√°c ƒë·ªãnh: ${error.message}.`;
            console.error('Error uploading invoice:', error);
        }
    });
        
    async function fetchInvoices(page = 1, filter = 'all') {
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        invoiceTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center"><div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ƒêang t·∫£i h√≥a ƒë∆°n...</div></td></tr>';

        try {
            let url = LIST_API_URL;
            let params = new URLSearchParams({ page: page, page_size: pageSize });

            if (filter !== 'all') {
                params.append('status', filter);
            }
            url += '?' + params.toString();

            const response = await fetch(url);
            
            if (response.headers.get('content-type') && response.headers.get('content-type').indexOf('application/json') === -1) {
                 throw new Error(`API tr·∫£ v·ªÅ HTML (L·ªói x√°c th·ª±c/quy·ªÅn?).`);
            }
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`API Error: ${JSON.stringify(error)}`);
            }
            
            const data = await response.json();
            
            // FIX QUAN TR·ªåNG: X√°c ƒë·ªãnh danh s√°ch h√≥a ƒë∆°n
            // N·∫øu API tr·∫£ v·ªÅ list tr·ª±c ti·∫øp (nh∆∞ ·∫£nh DRF), data_list l√† data
            // N·∫øu API tr·∫£ v·ªÅ ph√¢n trang (sau khi b·∫°n c·∫•u h√¨nh), data_list l√† data.results
            const data_list = Array.isArray(data) ? data : data.results;
            const total_count = Array.isArray(data) ? data.length : data.count;

            invoiceTableBody.innerHTML = '';
            
            if (data_list && data_list.length > 0) {
                data_list.forEach(invoice => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const statusClass = {
                        'UPLOADED': 'bg-blue-100 text-blue-800',
                        'OCR_PROCESSING': 'bg-blue-100 text-blue-800',
                        'OCR_PROCESSED': 'bg-yellow-100 text-yellow-800',
                        'PENDING_REVIEW': 'bg-yellow-100 text-yellow-800',
                        'MATCH_PROCESSING': 'bg-blue-100 text-blue-800',
                        'MATCHED': 'bg-green-100 text-green-800',
                        'UNMATCHED': 'bg-red-100 text-red-800',
                        'PENDING_APPROVAL': 'bg-purple-100 text-purple-800',
                        'APPROVED': 'bg-green-100 text-green-800',
                        'INTEGRATING': 'bg-blue-100 text-blue-800',
                        'INTEGRATED': 'bg-green-100 text-green-800',
                        'INTEGRATION_ERROR': 'bg-red-100 text-red-800',
                        'REJECTED': 'bg-gray-100 text-gray-800',
                    };
                    
                    const detailUrl = DETAIL_URL_TEMPLATE.replace('__INVOICE_ID__', invoice.id);

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${invoice.invoice_number || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${invoice.supplier_name_ocr || (invoice.supplier ? invoice.supplier.name : 'N/A')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${invoice.total_amount ? parseFloat(invoice.total_amount).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) : 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass[invoice.status] || 'bg-gray-100 text-gray-800'}">
                                ${invoice.status ? invoice.status.replace(/_/g, ' ').toLowerCase() : 'N/A'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${invoice.uploaded_at ? new Date(invoice.uploaded_at).toLocaleString('vi-VN') : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="${detailUrl}" class="text-indigo-600 hover:text-indigo-900">Xem chi ti·∫øt</a>
                        </td>
                    `;
                    invoiceTableBody.appendChild(row);
                });
            } else {
                invoiceTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>';
            }

            // Ch·ªâ c·∫≠p nh·∫≠t ph√¢n trang n·∫øu API tr·∫£ v·ªÅ t·ªïng s·ªë (count)
            if (typeof data.count === 'number') {
                updatePagination(data);
            } else {
                 document.getElementById('pagination').innerHTML = '';
            }

        } catch (error) {
            invoiceTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-red-500">L·ªói khi t·∫£i danh s√°ch h√≥a ƒë∆°n. Vui l√≤ng ki·ªÉm tra console.</td></tr>';
            console.error('Error fetching invoices:', error);
        }
    }

    // Gi·ªØ nguy√™n c√°c h√†m updatePagination v√† filterInvoices
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        // S·ª¨ D·ª§NG data.count
        if (data.count > pageSize) {
            const totalPages = Math.ceil(data.count / pageSize);
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.innerText = '¬´ Tr∆∞·ªõc';
                prevBtn.className = 'px-3 py-1 text-xs font-medium rounded-md bg-gray-200 hover:bg-gray-300';
                prevBtn.onclick = () => {
                    currentPage--;
                    fetchInvoices(currentPage, currentFilter);
                };
                pagination.appendChild(prevBtn);
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.innerText = i;
                pageBtn.className = `px-3 py-1 text-xs font-medium rounded-md ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
                pageBtn.onclick = () => {
                    currentPage = i;
                    fetchInvoices(currentPage, currentFilter);
                };
                pagination.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.innerText = 'Ti·∫øp ¬ª';
                nextBtn.className = 'px-3 py-1 text-xs font-medium rounded-md bg-gray-200 hover:bg-gray-300';
                nextBtn.onclick = () => {
                    currentPage++;
                    fetchInvoices(currentPage, currentFilter);
                };
                pagination.appendChild(nextBtn);
            }
        }
    }

    function filterInvoices(filter) {
        currentFilter = filter;
        currentPage = 1;
        fetchInvoices(currentPage, currentFilter);
    }

    // Initial load
    fetchInvoices(currentPage, currentFilter);

    // Auto refresh every 10 seconds
    setInterval(() => fetchInvoices(currentPage, currentFilter), 10000);
</script>
{% endblock %}
