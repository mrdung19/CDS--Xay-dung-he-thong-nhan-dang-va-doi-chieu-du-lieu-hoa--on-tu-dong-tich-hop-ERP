{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}Ph√¢n c√¥ng Nhi·ªám v·ª• - InvoiceFlow{% endblock %}

{% block content %}
<header class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-3xl font-semibold text-gray-800">üë• Ph√¢n c√¥ng Nhi·ªám v·ª•</h2>
        <p class="text-gray-600 mt-1">Giao nhi·ªám v·ª• cho nh√¢n vi√™n x·ª≠ l√Ω h√≥a ƒë∆°n</p>
    </div>
    <button id="createTaskBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-md">
        ‚ûï T·∫°o Nhi·ªám v·ª• M·ªõi
    </button>
</header>

<!-- Task Assignment Form Modal -->
<div id="taskAssignmentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold" id="modalTitle">T·∫°o Nhi·ªám v·ª• M·ªõi</h3>
            <button id="closeTaskModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="taskAssignmentForm">
            {% csrf_token %}
            <input type="hidden" id="taskId" name="id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <label for="invoiceSelect" class="block text-gray-700 text-sm font-bold mb-2">üìÑ Ch·ªçn H√≥a ƒë∆°n:</label>
                        <select id="invoiceSelect" name="invoice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Ch·ªçn h√≥a ƒë∆°n --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="taskType" class="block text-gray-700 text-sm font-bold mb-2">üìã Lo·∫°i Nhi·ªám v·ª•:</label>
                        <select id="taskType" name="task_type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Ch·ªçn lo·∫°i nhi·ªám v·ª• --</option>
                            <option value="OCR_REVIEW">üìù Review OCR</option>
                            <option value="MATCH_REVIEW">üîç Review Match</option>
                            <option value="APPROVAL">‚úÖ Ph√™ duy·ªát</option>
                            <option value="FRAUD_CHECK">üïµÔ∏è Ki·ªÉm tra Fraud</option>
                            <option value="ERP_SYNC">üîó ƒê·ªìng b·ªô ERP</option>
                            <option value="MANUAL_REVIEW">üë§ Ki·ªÉm tra th·ªß c√¥ng</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="assignedTo" class="block text-gray-700 text-sm font-bold mb-2">üë§ Giao cho:</label>
                        <select id="assignedTo" name="assigned_to" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="priority" class="block text-gray-700 text-sm font-bold mb-2">üî¥ ƒê·ªô ∆∞u ti√™n:</label>
                        <select id="priority" name="priority" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="LOW">üü¢ Th·∫•p</option>
                            <option value="MEDIUM" selected>üü° Trung b√¨nh</option>
                            <option value="HIGH">üî¥ Cao</option>
                        </select>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-4">
                    <div>
                        <label for="dueDate" class="block text-gray-700 text-sm font-bold mb-2">‚è∞ Th·ªùi h·∫°n:</label>
                        <input type="datetime-local" id="dueDate" name="due_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    
                    <div>
                        <label for="estimatedTime" class="block text-gray-700 text-sm font-bold mb-2">‚è±Ô∏è Th·ªùi gian ∆∞·ªõc t√≠nh (ph√∫t):</label>
                        <input type="number" id="estimatedTime" name="estimated_time" min="1" max="480" value="30" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    
                    <div>
                        <label for="tags" class="block text-gray-700 text-sm font-bold mb-2">üè∑Ô∏è Tags:</label>
                        <input type="text" id="tags" name="tags" placeholder="urgent, review, invoice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <p class="text-xs text-gray-500 mt-1">Ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y</p>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyAssignee" name="notify_assignee" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-sm text-gray-700">üìß Th√¥ng b√°o cho ng∆∞·ªùi ƒë∆∞·ª£c giao</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label for="description" class="block text-gray-700 text-sm font-bold mb-2">üìù M√¥ t·∫£ chi ti·∫øt:</label>
                <textarea id="description" name="description" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ nhi·ªám v·ª•, y√™u c·∫ßu ƒë·∫∑c bi·ªát, h∆∞·ªõng d·∫´n th·ª±c hi·ªán..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelTaskBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded">‚ùå H·ªßy</button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">üíæ T·∫°o Nhi·ªám v·ª•</button>
            </div>
        </form>
    </div>
</div>

<!-- Task Assignment Statistics -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">üìä T·ªïng nhi·ªám v·ª•</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="totalAssignedTasks">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9M21 12a9 9 0 00-9-9"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚è≥ ƒêang ch·ªù</h3>
                <p class="text-3xl font-bold text-yellow-500 mt-1" id="pendingAssignedTasks">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚úÖ Ho√†n th√†nh</h3>
                <p class="text-3xl font-bold text-green-500 mt-1" id="completedAssignedTasks">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚ö†Ô∏è Qu√° h·∫°n</h3>
                <p class="text-3xl font-bold text-red-500 mt-1" id="overdueAssignedTasks">0</p>
            </div>
        </div>
    </div>
</div>

<!-- Assigned Tasks List -->
<div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Danh s√°ch Nhi·ªám v·ª• ƒë√£ ph√¢n c√¥ng</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìÑ H√≥a ƒë∆°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìã Lo·∫°i</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üë§ Ng∆∞·ªùi th·ª±c hi·ªán</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‚è∞ Th·ªùi h·∫°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üî¥ ∆Øu ti√™n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìä Tr·∫°ng th√°i</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‚ö° H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="assignedTasksList" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c ph√¢n c√¥ng.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load data
        loadInvoices();
        loadUsers();
        loadAssignedTasks();
        
        // Set default due date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('dueDate').value = tomorrow.toISOString().slice(0, 16);
        
        // Event listeners
        document.getElementById('createTaskBtn').addEventListener('click', openTaskModal);
        document.getElementById('closeTaskModalBtn').addEventListener('click', closeTaskModal);
        document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
        document.getElementById('taskAssignmentForm').addEventListener('submit', handleTaskSubmit);
    });
    
    function openTaskModal() {
        document.getElementById('taskAssignmentModal').classList.remove('hidden');
        document.getElementById('taskAssignmentModal').classList.add('flex');
    }
    
    function closeTaskModal() {
        document.getElementById('taskAssignmentModal').classList.add('hidden');
        document.getElementById('taskAssignmentModal').classList.remove('flex');
        document.getElementById('taskAssignmentForm').reset();
    }
    
    async function loadInvoices() {
        try {
            const response = await fetch('/api/invoices/');
            const data = await response.json();
            
            const select = document.getElementById('invoiceSelect');
            select.innerHTML = '<option value="">-- Ch·ªçn h√≥a ƒë∆°n --</option>';
            
            if (data.results) {
                data.results.forEach(invoice => {
                    const option = document.createElement('option');
                    option.value = invoice.id;
                    option.textContent = `#${invoice.id} - ${invoice.invoice_number || 'Ch∆∞a c√≥ s·ªë'} (${invoice.status})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading invoices:', error);
        }
    }
    
    async function loadUsers() {
        try {
            // This would typically come from a users API
            const users = [
                { id: 1, username: 'admin', full_name: 'Administrator' },
                { id: 2, username: 'user1', full_name: 'Nguy·ªÖn VƒÉn A' },
                { id: 3, username: 'user2', full_name: 'Tr·∫ßn Th·ªã B' },
                { id: 4, username: 'user3', full_name: 'L√™ VƒÉn C' }
            ];
            
            const select = document.getElementById('assignedTo');
            select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.full_name} (${user.username})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async function loadAssignedTasks() {
        try {
            const response = await fetch('/api/tasks/');
            const data = await response.json();
            
            updateTaskStatistics(data.results || []);
            displayAssignedTasks(data.results || []);
        } catch (error) {
            console.error('Error loading assigned tasks:', error);
        }
    }
    
    function updateTaskStatistics(tasks) {
        document.getElementById('totalAssignedTasks').textContent = tasks.length;
        document.getElementById('pendingAssignedTasks').textContent = tasks.filter(t => t.status === 'PENDING').length;
        document.getElementById('completedAssignedTasks').textContent = tasks.filter(t => t.status === 'COMPLETED').length;
        document.getElementById('overdueAssignedTasks').textContent = tasks.filter(t => t.status === 'OVERDUE').length;
    }
    
    function displayAssignedTasks(tasks) {
        const tbody = document.getElementById('assignedTasksList');
        tbody.innerHTML = '';
        
        if (tasks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c ph√¢n c√¥ng.</td></tr>';
            return;
        }
        
        tasks.forEach(task => {
            const row = document.createElement('tr');
            
            // Status styling
            let statusClass = '';
            let statusText = '';
            switch (task.status) {
                case 'PENDING':
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'ƒêang ch·ªù';
                    break;
                case 'IN_PROGRESS':
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'ƒêang l√†m';
                    break;
                case 'COMPLETED':
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Ho√†n th√†nh';
                    break;
                case 'OVERDUE':
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Qu√° h·∫°n';
                    break;
                default:
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusText = 'Kh√¥ng r√µ';
            }
            
            // Priority styling
            let priorityClass = '';
            let priorityText = '';
            switch (task.priority) {
                case 'HIGH':
                    priorityClass = 'bg-red-100 text-red-800';
                    priorityText = 'üî¥ Cao';
                    break;
                case 'MEDIUM':
                    priorityClass = 'bg-yellow-100 text-yellow-800';
                    priorityText = 'üü° Trung b√¨nh';
                    break;
                case 'LOW':
                    priorityClass = 'bg-green-100 text-green-800';
                    priorityText = 'üü¢ Th·∫•p';
                    break;
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">
                    <a href="/invoices/${task.invoice}/detail/">#${task.invoice}</a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.task_type}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.assigned_to_username || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(task.due_date).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${priorityClass}">
                        ${priorityText}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editTask(${task.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">S·ª≠a</button>
                    <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-900">X√≥a</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    async function handleTaskSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const taskData = {
            invoice: formData.get('invoice'),
            task_type: formData.get('task_type'),
            assigned_to: formData.get('assigned_to'),
            priority: formData.get('priority'),
            due_date: formData.get('due_date'),
            estimated_time: formData.get('estimated_time'),
            tags: formData.get('tags'),
            description: formData.get('description'),
            notify_assignee: formData.get('notify_assignee') === 'on'
        };
        
        try {
            const response = await fetch('/api/tasks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(taskData)
            });
            
            if (response.ok) {
                alert('‚úÖ Nhi·ªám v·ª• ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                closeTaskModal();
                loadAssignedTasks();
            } else {
                const error = await response.json();
                alert('‚ùå L·ªói: ' + (error.detail || 'Kh√¥ng th·ªÉ t·∫°o nhi·ªám v·ª•'));
            }
        } catch (error) {
            console.error('Error creating task:', error);
            alert('‚ùå L·ªói m·∫°ng: ' + error.message);
        }
    }
    
    function editTask(taskId) {
        alert('Ch·ª©c nƒÉng s·ª≠a nhi·ªám v·ª• s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn');
    }
    
    function deleteTask(taskId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nhi·ªám v·ª• n√†y?')) {
            alert('Ch·ª©c nƒÉng x√≥a nhi·ªám v·ª• s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn');
        }
    }
</script>
{% endblock %}

