{% extends 'app_invoices/base.html' %}
{% load static %}

{% block title %}Nhi·ªám v·ª• - InvoiceFlow{% endblock %}

{% block content %}
<header class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-3xl font-semibold text-gray-800">üìã Nhi·ªám v·ª• c·ªßa t√¥i</h2>
        <p class="text-gray-600 mt-1">Qu·∫£n l√Ω c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao</p>
    </div>
</header>

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">üîç B·ªô l·ªçc nhi·ªám v·ª• n√¢ng cao</h3>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
            <label for="taskStatusFilter" class="block text-gray-700 text-sm font-bold mb-2">Tr·∫°ng th√°i:</label>
            <select id="taskStatusFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="PENDING">üü° ƒêang ch·ªù</option>
                <option value="IN_PROGRESS">üîµ ƒêang th·ª±c hi·ªán</option>
                <option value="COMPLETED">üü¢ Ho√†n th√†nh</option>
                <option value="OVERDUE">üî¥ Qu√° h·∫°n</option>
                <option value="CANCELLED">‚ö´ ƒê√£ h·ªßy</option>
            </select>
        </div>
        <div>
            <label for="taskTypeFilter" class="block text-gray-700 text-sm font-bold mb-2">Lo·∫°i nhi·ªám v·ª•:</label>
            <select id="taskTypeFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">T·∫•t c·∫£ lo·∫°i</option>
                <option value="OCR_REVIEW">üìù Review OCR</option>
                <option value="MATCH_REVIEW">üîç Review Match</option>
                <option value="APPROVAL">‚úÖ Ph√™ duy·ªát</option>
                <option value="FRAUD_CHECK">üïµÔ∏è Ki·ªÉm tra Fraud</option>
                <option value="ERP_SYNC">üîó ƒê·ªìng b·ªô ERP</option>
                <option value="MANUAL_REVIEW">üë§ Ki·ªÉm tra th·ªß c√¥ng</option>
            </select>
        </div>
        <div>
            <label for="priorityFilter" class="block text-gray-700 text-sm font-bold mb-2">ƒê·ªô ∆∞u ti√™n:</label>
            <select id="priorityFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">T·∫•t c·∫£ ƒë·ªô ∆∞u ti√™n</option>
                <option value="HIGH">üî¥ Cao</option>
                <option value="MEDIUM">üü° Trung b√¨nh</option>
                <option value="LOW">üü¢ Th·∫•p</option>
            </select>
        </div>
        <div>
            <label for="dateRange" class="block text-gray-700 text-sm font-bold mb-2">Th·ªùi gian:</label>
            <select id="dateRange" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                <option value="today">üìÖ H√¥m nay</option>
                <option value="tomorrow">üìÖ Ng√†y mai</option>
                <option value="week">üìÖ Tu·∫ßn n√†y</option>
                <option value="month">üìÖ Th√°ng n√†y</option>
                <option value="overdue">‚ö†Ô∏è Qu√° h·∫°n</option>
            </select>
        </div>
        <div class="flex items-end space-x-2">
            <button id="applyTaskFilters" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-md">
                üîç √Åp d·ª•ng
            </button>
            <button id="clearTaskFilters" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md shadow-md">
                üóëÔ∏è X√≥a b·ªô l·ªçc
            </button>
        </div>
    </div>
</div>

<!-- Task Statistics -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">üìä T·ªïng nhi·ªám v·ª•</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="totalTasks">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9M21 12a9 9 0 00-9-9"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚è≥ ƒêang ch·ªù x·ª≠ l√Ω</h3>
                <p class="text-3xl font-bold text-yellow-500 mt-1" id="pendingTasks">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚úÖ ƒê√£ ho√†n th√†nh</h3>
                <p class="text-3xl font-bold text-green-500 mt-1" id="completedTasks">0</p>
            </div>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">‚ö†Ô∏è Qu√° h·∫°n</h3>
                <p class="text-3xl font-bold text-red-500 mt-1" id="overdueTasks">0</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">‚ö° H√†nh ƒë·ªông nhanh</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <button id="bulkCompleteBtn" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md shadow-md flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Ho√†n th√†nh h√†ng lo·∫°t
        </button>
        <button id="assignTasksBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md shadow-md flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
            </svg>
            Ph√¢n c√¥ng nhi·ªám v·ª•
        </button>
        <button id="exportTasksBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-md shadow-md flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Xu·∫•t b√°o c√°o
        </button>
        <button id="refreshTasksBtn" class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-md shadow-md flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            L√†m m·ªõi
        </button>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Danh s√°ch Nhi·ªám v·ª•</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <input type="checkbox" id="selectAllTasks" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìÑ H√≥a ƒë∆°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìã Lo·∫°i Nhi·ªám v·ª•</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‚è∞ Th·ªùi h·∫°n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üë§ Ng∆∞·ªùi giao</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üî¥ ƒê·ªô ∆∞u ti√™n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">üìä Tr·∫°ng th√°i</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‚ö° H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="taskListBody" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ƒê·ªãnh nghƒ©a URL chi ti·∫øt h√≥a ƒë∆°n (s·ª≠ d·ª•ng placeholder)
        const INVOICE_DETAIL_URL_TEMPLATE = "/invoices/__INVOICE_ID__/detail/"; // Thay th·∫ø c·ª©ng n·∫øu kh√¥ng c√≥ t√™n URL
        
        const fetchTasks = async (filters = {}) => {
            // L·∫•y URL API t·ª´ template (ƒë∆∞·ªùng d·∫´n ƒë√£ ƒë∆∞·ª£c s·ª≠a l·ªói)
            const apiUrl = "{% url 'api-tasks-list' %}"; // T√™n route tasks list API t·ª´ router
            // X√¢y d·ª±ng chu·ªói truy v·∫•n (query string)
            const queryString = new URLSearchParams(filters).toString();
            
            try {
                const response = await fetch(`${apiUrl}?${queryString}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // C·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™
                document.getElementById('totalTasks').textContent = data.length;
                document.getElementById('pendingTasks').textContent = data.filter(t => t.status === 'PENDING' || t.status === 'IN_PROGRESS').length;
                document.getElementById('completedTasks').textContent = data.filter(t => t.status === 'COMPLETED').length;
                
                // Hi·ªÉn th·ªã danh s√°ch nhi·ªám v·ª•
                const taskListBody = document.getElementById('taskListBody');
                taskListBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©

                if (data.length === 0) {
                    taskListBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</td></tr>';
                    return;
                }

                data.forEach(task => {
                    const row = document.createElement('tr');
                    
                    // T·∫°o m√†u s·∫Øc cho tr·∫°ng th√°i
                    let statusClass = '';
                    let statusText = '';
                    switch (task.status) {
                        case 'PENDING':
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = 'ƒêang ch·ªù';
                            break;
                        case 'IN_PROGRESS':
                            statusClass = 'bg-blue-100 text-blue-800';
                            statusText = 'ƒêang l√†m';
                            break;
                        case 'COMPLETED':
                            statusClass = 'bg-green-100 text-green-800';
                            statusText = 'Ho√†n th√†nh';
                            break;
                        default:
                            statusClass = 'bg-gray-100 text-gray-800';
                            statusText = 'Kh√¥ng r√µ';
                    }
                    
                    // T·∫°o URL chi ti·∫øt
                    const detailUrl = INVOICE_DETAIL_URL_TEMPLATE.replace('__INVOICE_ID__', task.invoice);


                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600 hover:text-indigo-900">
                            <a href="${detailUrl}">${task.invoice}</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.task_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(task.assigned_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.assigned_to_username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="${detailUrl}" class="text-indigo-600 hover:text-indigo-900">Xem/X·ª≠ l√Ω</a>
                        </td>
                    `;
                    taskListBody.appendChild(row);
                });
            } catch (error) {
                console.error('L·ªói khi t·∫£i danh s√°ch nhi·ªám v·ª•:', error);
                document.getElementById('taskListBody').innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>';
            }
        };

        // L·∫Øng nghe s·ª± ki·ªán click √°p d·ª•ng b·ªô l·ªçc
        document.getElementById('applyTaskFilters').addEventListener('click', function() {
            const status = document.getElementById('taskStatusFilter').value;
            const type = document.getElementById('taskTypeFilter').value;
            // dateRange s·∫Ω c·∫ßn logic ph·ª©c t·∫°p h∆°n, t·∫°m th·ªùi b·ªè qua
            
            const filters = {};
            if (status) filters.status = status;
            if (type) filters.task_type = type;

            fetchTasks(filters);
        });

        // T·∫£i nhi·ªám v·ª• l·∫ßn ƒë·∫ßu
        fetchTasks();
    });
</script>
{% endblock content %}